<% date_vars.each do |var| %>
  <%= hidden_field_tag var, params[var] %>
<% end %>

<%= label_tag nil, date_vars.join(" & ") %>
<div class="selectize-control single" style="width: 300px;">
  <div id="reportrange" class="selectize-input" style="display: inline-block;">
    <span>Select a time range</span>
  </div>
</div>

<script>
  var timeZone = "<%= Blazer.time_zone.tzinfo.name %>";
  var format = "YYYY-MM-DD";
  var now = moment.tz(timeZone);
  var $reportRange = $('#reportrange');
  var $startTime = $("#start_time");
  var $endTime = $("#end_time");
  var ranges = {
    "Today": [dateStr(), dateStr()],
    "Last 7 Days": [dateStr(6), dateStr()],
    "Last 30 Days": [dateStr(29), dateStr()]
  };
  var startDate = ranges["<%= Blazer.date_range %>"][0];

  function dateStr(daysAgo) {
    return now.clone().subtract(daysAgo || 0, "days").format(format);
  }

  function toDate(time) {
    return moment.tz(time.format(format), timeZone);
  }

  function setTimeInputs(start, end) {
    $startTime.val(toDate(start).utc().format());
    $endTime.val(toDate(end).endOf("day").utc().format());
  }

  $reportRange.daterangepicker(
    {
      ranges: ranges,
      locale: {
        format: format
      },
      startDate: startDate,
      endDate: dateStr(),
      opens: "right"
    },
    function(start, end) {
      setTimeInputs(start, end);
      submitIfCompleted($startTime.closest("form"));
    }
  ).on('apply.daterangepicker', function(ev, picker) {
    setTimeInputs(picker.startDate, picker.endDate);
    $reportRange.find('span').html(toDate(picker.startDate).format('MMMM D, YYYY') + ' - ' + toDate(picker.endDate).format('MMMM D, YYYY'));
  })

  var picker = $reportRange.data('daterangepicker');
  if ($startTime.val().length > 0) {
    picker.setStartDate(moment.tz($startTime.val(), timeZone));
    picker.setEndDate(moment.tz($endTime.val(), timeZone));
    $reportRange.trigger('apply.daterangepicker', picker)
  } else {
    $reportRange.trigger('apply.daterangepicker', picker);
    submitIfCompleted($startTime.closest("form"));
  }
</script>
