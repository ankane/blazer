<% blazer_title @query.name %>

<% content_for :topbar do %>
  <div class="topbar">
    <div class="container">
      <div class="row" style="padding-top: 13px;">
        <div class="col-sm-6 col-xs-12">
          <h3 style="margin: 0; line-height: 34px; display: inline;">
            <%= @query.name %>
          </h3>
        </div>
        <div class="col-sm-6 col-xs-12 text-right">
          <%= render partial: "blazer/nav" %>
          <%= link_to "Edit", edit_query_path(@query, variable_params), class: "btn btn-default", disabled: !@query.editable?(blazer_user) %>
          <%= link_to "Fork", new_query_path(variable_params.merge(fork_query_id: @query.id, data_source: @query.data_source, name: @query.name)), class: "btn btn-info" %>

          <% if !@error && @success %>
            <%= button_to "Download", run_queries_path(query_id: @query.id, format: "csv"), params: {statement: @statement}, class: "btn btn-primary" %>
          <% end %>
        </div>
      </div>
    </div>
  </div>
<% end %>

<% if @sql_errors.any? %>
  <div class="alert alert-danger">
    <ul>
      <% @sql_errors.each do |message| %>
        <li><%= message %></li>
      <% end %>
    </ul>
  </div>
<% end %>

<% if @query.description.present? %>
  <p><%= @query.description %></p>
<% end %>

<%= render partial: "blazer/variables", locals: {action: query_path(@query)} %>

<pre id="code"><code><%= @statement %></code></pre>

<% if @success %>
  <div id="results">
    <p class="text-muted">Loading...</p>
  </div>

  <script>
    function showRun(data) {
      $("#results").html(data);
      $("#results table").stupidtable().stickyTableHeaders({fixedOffset: 0});
    }

    function showError(message) {
      $("#results").css("color", "red").html(message);
    }

    var data = <%= blazer_json_escape(variable_params.merge(statement: @statement, query_id: @query.id).to_json).html_safe %>;

    runQuery(data, showRun, showError);
  </script>
<% end %>

<% if %w[sql presto].include?(Blazer.data_sources[@query.data_source].adapter) %>
  <script>
    // do not highlight really long queries
    // this can lead to performance issues
    if ($("code").text().length < 10000) {
      hljs.highlightBlock(document.getElementById("code"));
    }
  </script>
<% end %>
